{"code":"import { isArray } from \"@vue/shared\";\r\nimport { isIntergerKey } from \"../../shared/src/index\";\r\nexport function effect(fn, options = {}) {\r\n    // 需要让effect变成响应的effect,可以做到数据变化重新执行\r\n    const effect = createReactiveEffect(fn, options);\r\n    if (!options.lazy) {\r\n        //默认的effect会先执行\r\n        effect(); //响应式的effect默认先执行一次\r\n    }\r\n    return effect;\r\n}\r\nlet uid = 0;\r\nlet activeEffect; //存储当前的effect\r\nconst effectStack = [];\r\nfunction createReactiveEffect(fn, options) {\r\n    const effect = function reactiveEffect() {\r\n        // 保证effect没有加入到effectStack中\r\n        if (!effectStack.includes(effect)) {\r\n            try {\r\n                effectStack.push(effect);\r\n                activeEffect = effect;\r\n                return fn(); //函数执行会取值 会执行get方法\r\n            }\r\n            finally {\r\n                effectStack.pop();\r\n                activeEffect = effectStack[effectStack.length - 1];\r\n            }\r\n        }\r\n    };\r\n    effect.id = uid++; //制作一个effect标识 用于区分effect\r\n    effect._isEffect = true; //用于标识这个式响应式的effect\r\n    effect.raw = fn; //保留effect对应的原函数\r\n    effect.options = options; //在effect上保存用户的属性\r\n    return effect;\r\n}\r\n// 让某个对象中的属性收集当前他对应的effect函数\r\nconst targetMap = new WeakMap();\r\nexport function track(target, type, key) {\r\n    // activeEffect 可以拿到当前的effect\r\n    console.log(target, type, key);\r\n    if (activeEffect === undefined) {\r\n        //此属性不用收集，因为没有effect使用\r\n        return;\r\n    }\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        targetMap.set(target, (depsMap = new Map()));\r\n    }\r\n    let dep = depsMap.get(key);\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set()));\r\n    }\r\n    if (!dep.has(activeEffect)) {\r\n        dep.add(activeEffect);\r\n    }\r\n    console.log(targetMap);\r\n}\r\nexport function trigger(target, type, key, newValue, oldValue) {\r\n    // 如果这个属性没有收集过effect 那就不需要做任何操作\r\n    const depsMap = targetMap.get(target);\r\n    if (!depsMap)\r\n        return;\r\n    const effects = new Set();\r\n    const add = (effectToAdd) => {\r\n        if (effectToAdd) {\r\n            effectToAdd.forEach((effect) => {\r\n                effects.add(effect);\r\n            });\r\n        }\r\n    };\r\n    // 将所有要执行的effect 全部存到一个新的集合中，最终一起执行\r\n    // 1.看修改的是不是数组的长度，因为该长度影响比较大\r\n    if (key === \"length\" && isArray(target)) {\r\n        depsMap.forEach((dep, key) => {\r\n            if (key === \"length\" || key > newValue) {\r\n                // 如果更改的长度小于收集的索引，那么索引也要触发effect重新执行\r\n                add(dep);\r\n            }\r\n        });\r\n    }\r\n    else {\r\n        // 可能是对象\r\n        if (key !== undefined) {\r\n            add(depsMap.get(key));\r\n        }\r\n        // 如果数组中的某一个索引怎么办？\r\n        switch (type) {\r\n            case 0 /* TriggerOrTypes.ADD */:\r\n                if (isArray(target) && isIntergerKey(key)) {\r\n                    add(depsMap.get(\"length\"));\r\n                }\r\n        }\r\n    }\r\n    effects.forEach((effect) => effect());\r\n}\r\n// 函数调用是一个栈型结构\r\n//# sourceMappingURL=effect.js.map","references":["D:/学习/学习计划/Study-Vue3/vue3/packages/shared/src/index.ts","D:/学习/学习计划/Study-Vue3/vue3/packages/reactivity/src/operators.ts","D:/学习/学习计划/Study-Vue3/vue3/packages/shared/src/index.ts"],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/reactivity/src/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
